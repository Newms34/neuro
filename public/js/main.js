"use strict";var app=angular.module("neur-app",[]).controller("neur-con",["$scope","$http",function(e,n){e.h=$("#brain").height(),e.w=$("#brain").width(),e.playw=$("#playfield").width()-50,e.playh=$("#playfield").height()-50,e.neurons=[],e.outs=[],e.ins=[],e.numIns=5,e.numBaseCons=5,e.numOuts=7,e.lastDeath=null,e.okayRun=!0,e.scores=[],e.scoreAvgs=[],e.scoreAvg=null,e.tracePath=!1,e.speed=150,e.speedRaw=86,e.numGenerations=0,e.hideCons=!1,e.prey={x:.5*e.w,y:.5*e.h,dx:10*Math.random()-5,dy:10*Math.random()-5,facing:0},e.org={x:0,y:0},bootbox.dialog({title:"Neuron Simulation Startup Options",message:'<div class="form-group col-md-12">\n    <div class="col-md-5">Number of neurons</div>\n    <div class="col-md-6">\n        <input type="number" id="num-in" value="200" />\n    </div>\n</div>\n<br/>\n<br/>\n<div class="form-group col-md-12">\n    <div class="col-md-5">Connections Per Neuron (percent of total)</div>\n    <div class="col-md-6">\n        <div class="col-md-1">0%</div>\n        <div class="col-md-8">\n            <input type="range" min="1" value="20" max="50" id="numConnects" />\n        </div>\n        <div class="col-md-1">50%</div>\n    </div>\n</div>\n<br/>\n<br/>\n<div class="form-group col-md-12">\n    <div class="col-md-5">Hide connections </div>\n    <div class="col-md-6">\n        <input type="checkbox" id="con-status" />\n    </div>\n</div>\n',buttons:{confirm:{label:"Create",className:"btn-success",callback:function(){if(isNaN(parseInt($("#num-in").val())))bootbox.alert("Please enter a number of neurons");else{if(!(parseInt($("#num-in").val())<5))return e.numNeurs=parseInt($("#num-in").val()),e.numBaseCons=e.numNeurs*parseInt($("#numConnects").val())/100,e.hideCons=$("#con-status")[0].checked,e.$apply(),e.drawInitBoard(),!0;bootbox.alert("Number of neurons too low!")}return!1}},help:{label:"?",className:"btn-danger",callback:function(){return e.showHalp(),!1}}}}),e.showHalp=function(){bootbox.alert({title:"<h3>Dave's Brain Sim v1.2.1</h3>",message:"\n<h4>About</h4> Dave's Brain Sim is a relatively simple brain simulation, using randomly generated 'pure' neural networks.\n<hr>\n<h4>Goal</h4> The overall goal of the simulation is for the prey item (in blue) to catch the prey item (red or green).\n<hr>\n<h4>Recommended Settings</h4> &#9745; Unless you have a really powerful system, I'd recommend around 500-800 neurons. Any fewer will limit the amount that the system can learn, and any more will severely impede performance (and thus generation duration, and learning speed).\n<br>&#9745; I would also suggest that you keep 'Hide connections' checked, as while the system can (and will!) draw neural connections, this'll severely impede performance.\n<br>&#9745; If you <em>do</em> elect to uncheck 'Hide connections', consider only showing active connections to increase performance. This is available in the simulation options, available after pressing Create (press the green [&#9881;] button). \n<br>&#9745; I'd suggest you lock the prey item to the center. This will convert the prey item into, essentially, a primary producer, and will eliminate the issue of the prey item running away from (or directly into!) the organism. This is available in the simulation options, available after pressing Create.\n<br>&#9745; Finally, I'd suggest you keep 'Auto-repeat' checked to have the simulation automatically refresh after an organism hits its end state. This is available in the simulation options, available after pressing Create.\n<hr>\n<h4>How It Works</h4>\n<ol>\n    <li>\n        The neural network works by first generating a number of randomly placed neurons, as well as a number of connections between those neurons. Each connection is given a weight. If a particular neuron is active, this weight determines how likely a given output connection is to <em>also</em> be active.\n    </li>\n    <li>\n        The initial inputs are a series of distance sensors, which have a higher chance of being on ('active') the closer they are to their targets. Each of the organism's 'eyes' is in fact a pair of sensors: one for close range, and one for distance.</li>\n    <li>\n        Each generation consists of a number of cycles, run until the simulation encounters an End Condition (see below). During each cycle, each active neuron randomly picks another neuron via its weighted connections. The chosen connections are kept as an activeConnections list.</li>\n    <li>\n        After each generation finishes, a score is calculated as a combination of time taken, distance from final prey item, and other factors.</li>\n    <li>\n        A running tally is kept of the score, and the organism's current score is compared to a running average of the past three scores. This is done to prevent random 'fluke' scores from being over-weighted.</li>\n    <li>\n        If the score is <em>greater</em> than the average, the connections involved are made heavier (i.e., more likely to be chosen in the future. Otherwise, the connections are made lighter (less likely to be chosen).</li>\n    <li>\n        This repeats.</li>\n</ol>\n<hr>\n<h4>End Conditions</h4> The simulation ends in one of five situations:\n<ul>\n    <li>\n        <strong>Death from User:</strong> Caused by unchecking the \"Uncheck to Halt\" box in options.\n    </li>\n    <li>\n        <strong>Death from overheating:</strong> Caused by too many neurons (greater than 90%) being active during any one cycle. This is akin to a seizure.\n    </li>\n    <li>\n        <strong>Death from lack of neural activity:</strong> The polar opposite of Death from overheating. Caused by too few neurons being active. Akin to brain death.\n    </li>\n    <li>\n        <strong>Death from lack of energy:</strong> Caused by the energy remaining timer hitting zero before the prey is caught. This is to prevent the organism just wandering around without a purpose\n    </li>\n    <li>\n        <strong>Successful hunt</strong> Obviously, caused by the organism successfully catching the prey item. Achieves the highest score.\n    </li>\n</ul>\n<hr>\n<h4>Frequently Asked Questions</h4>\n<ul>\n    <li>\n        <em>What does the organism start out knowing?</em><br>\n        Nothing! It doesn't even know that, for example, having all four distance sensors active is generally good (since it means the prey item is closer.)\n    </li>\n    <li>\n        <em>My organism doesn't seem to be doing much...</em><br>\n        Be aware that this is an entirely unguided neural learning simulation. As such, it may take a while for the organism to 'figure things out'.\n    </li>\n    <li>\n        <em>How can I be sure that my organism is, in fact, learning?</em><br>\n        While the individual scores can and will fluctuate a lot (especially at first!), you should eventually notice a slight upward trend. \n    </li>\n    <li>\n        <em>What technologies is this running on?</em><br>\n        Dave's Brain Sim uses the following tech:\n        <ul>\n            <li>NodeJS - for the backend</li>\n            <li>ExpressJS - for routing</li>\n            <li>GulpJS - for making everything nice and smol to send to your browser</li>\n            <li>AngularJS - for dynamic front-end stuffs!</li>\n            <li>ChartJS - for drawing graphs!</li>\n        </ul>\n    </li>\n</ul>\n\n",size:"large"})},e.activeNeurs=[],e.changeSpeed=function(){e.speed=-10*e.speedRaw+1010},e.outConst=function(n,t){this.x=e.w,this.y=e.h*e.outs.length/e.numOuts,this.z=Math.floor(Math.random()*(e.w-10)),this.active=!1,this.action=n,this.does=t},e.inConst=function(){this.x=50,this.y=e.h*e.ins.length/e.numIns,this.z=0,this.o=[],this.active=!1},e.neurConst=function(){this.i=[],this.o=[],this.x=Math.floor(Math.random()*(e.w-10)),this.y=Math.floor(Math.random()*(e.h-10)),this.z=Math.floor(Math.random()*(e.w-10)),this.mood=.1,this.active=!1,this.doesSplit=Math.random()>.9},e.connection=function(e,n,t,a){this.source=e,this.target=n,this.weight=t,this.active=!0,this.out=1==a},e.drawInitBoard=function(){e.totalEn=12e4,e.remainingEn=e.totalEn,e.enPerNeur=e.totalEn/(e.speed*e.numNeurs);for(var n=0;n<e.numNeurs;n++)e.neurons.push(new e.neurConst);e.outs.push(new e.outConst("Move right",function(){e.org.x<e.playw-3&&(e.org.x+=3)})),e.outs.push(new e.outConst("Move left",function(){e.org.x>3&&(e.org.x-=3)})),e.outs.push(new e.outConst("Move down",function(){e.org.y<e.playh-3&&(e.org.y+=3)})),e.outs.push(new e.outConst("Move up",function(){e.org.y>3&&(e.org.y-=3)}));var t=Math.ceil(.1*Math.random()*e.numNeurs);e.ins.push(new e.inConst);for(o=0;o<t;o++){var a=!1,r=.1+.8*Math.random();a=Math.floor(Math.random()*e.numNeurs),e.neurons[a].i.push("inLeftSm"),e.ins[0].o.push(new e.connection(0,a,r,2))}e.ins.push(new e.inConst);for(o=0;o<t;o++){var a=!1,r=.1+.8*Math.random();a=Math.floor(Math.random()*e.numNeurs),e.neurons[a].i.push("inRightSm"),e.ins[1].o.push(new e.connection(1,a,r,2))}e.ins.push(new e.inConst);for(o=0;o<t;o++){var a=!1,r=.1+.8*Math.random();a=Math.floor(Math.random()*e.numNeurs),e.neurons[a].i.push("inLeftBg"),e.ins[2].o.push(new e.connection(2,a,r,2))}e.ins.push(new e.inConst);for(o=0;o<t;o++){var a=!1,r=.1+.8*Math.random();a=Math.floor(Math.random()*e.numNeurs),e.neurons[a].i.push("inRightBg"),e.ins[3].o.push(new e.connection(3,a,r,2))}for(n=0;n<e.numNeurs;n++)for(var o=0;o<e.numBaseCons;o++){var a=!1,r=.1+.8*Math.random();if(Math.random()<.98){for(a=Math.floor(Math.random()*e.numNeurs);a==n||-1!=e.neurons[n].i.indexOf(a);)a=Math.floor(Math.random()*e.numNeurs);e.neurons[a].i.push(n),e.neurons[n].o.push(new e.connection(n,a,r,0))}else a=Math.floor(Math.random()*e.outs.length),e.neurons[n].o.push(new e.connection(n,a,r,1))}e.$apply(),e.drawBoard()},e.scoreGraff={type:"line",data:{labels:[],datasets:[{label:"Score",data:[],borderColor:"#009",fill:!1},{label:"Score Average",data:[],borderColor:"#090",fill:!1}]}},e.ctx=document.querySelector("#brain-canv").getContext("2d"),e.cw=$("#brain").width(),e.ch=$("#brain").height();var t=e.ctx.createLinearGradient(0,0,100,0);t.addColorStop(0,"rgba(250,0,0,.5)"),t.addColorStop(1,"rgba(0,250,0,.5)"),e.drawBoard=function(){e.ctx.fillStyle="#000",e.ctx.fillRect(0,0,e.cw,e.ch),e.ctx.strokeStyle="#005",e.ctx.lineWidth=1,e.hideCons||e.ins.forEach(function(n){n.o.forEach(function(t){n.active?(e.ctx.strokeStyle="#00d",e.ctx.lineWidth=2):(e.ctx.strokeStyle="#005",e.ctx.lineWidth=.1),e.ctx.beginPath(),e.ctx.moveTo(0,n.y),e.ctx.lineTo(e.neurons[t.target].x,e.neurons[t.target].y),e.ctx.stroke(),e.ctx.closePath()})}),e.neurons.forEach(function(n){e.ctx.fillStyle=n.active?"#ccf":"#555",e.ctx.fillRect(n.x-3,n.y-3,6,6),e.hideCons||n.o.forEach(function(a){n.active?(e.ctx.strokeStyle=t,e.ctx.lineWidth=5*a.weight):(e.ctx.strokeStyle="rgba(0,0,150,.5)",e.ctx.lineWidth=.1),e.hideCons||!n.active&&e.hideInactCon||(e.ctx.beginPath(),e.ctx.moveTo(n.x,n.y),e.ctx.lineTo(e.neurons[a.target].x,e.neurons[a.target].y),e.ctx.stroke(),e.ctx.closePath())})})},e.movePrey=function(){if(!e.lockPrey){Math.random()>.98&&(e.prey.dx=10*Math.random()-5),Math.random()>.98&&(e.prey.dy=10*Math.random()-5),e.prey.dx<0&&e.prey.dx+e.prey.x<0?e.prey.dx=5*Math.random():e.prey.dx>0&&e.prey.dx+e.prey.x>e.playw&&(e.prey.dx=0-5*Math.random()),e.prey.dy<0&&e.prey.dy+e.prey.y<0?e.prey.dy=5*Math.random():e.prey.dy>0&&e.prey.dy+e.prey.y>e.playh&&(e.prey.dy=0-5*Math.random()),e.prey.x+=e.prey.dx,e.prey.y+=e.prey.dy;var n=180*Math.atan(e.prey.dy/e.prey.dx)/Math.PI;e.prey.facing=e.dx>0?n+90:n-90}},e.currPath=[[],[]],e.activePath=[[],[]],e.run=function(){e.activePath=[[],[]];for(var n=[],t=0;t<e.activeNeurs.length;t++){for(var a=[],r=0;r<e.neurons[e.activeNeurs[t]].o.length;r++)for(var o=Math.ceil(99*e.neurons[e.activeNeurs[t]].o[r].weight),s=0;s<o;s++)a.push(r);e.neurons[e.activeNeurs[t]].active=!1;for(var i=a[Math.floor(Math.random()*a.length)],h=a[Math.floor(Math.random()*a.length)],c=5e3;i==h&&c&&e.neurons[e.activeNeurs[t]].o.length>1;)h=a[Math.floor(Math.random()*a.length)],c--;Math.random()>.01&&(e.neurons[e.activeNeurs[t]].o[i].out?e.outs[e.neurons[e.activeNeurs[t]].o[i].target].active=!e.outs[e.neurons[e.activeNeurs[t]].o[i].target].active:(-1==n.indexOf(e.neurons[e.activeNeurs[t]].o[i].target)&&n.push(e.neurons[e.activeNeurs[t]].o[i].target),e.neurons[e.neurons[e.activeNeurs[t]].o[i].target].active=!0),e.currPath[0].push([e.activeNeurs[t],e.neurons[e.activeNeurs[t]].o[i]]),e.activePath[0].push([e.activeNeurs[t],e.neurons[e.activeNeurs[t]].o[i]]),e.neurons[e.activeNeurs[t]].doesSplit&&c&&(e.neurons[e.activeNeurs[t]].o[h].out?e.outs[e.neurons[e.activeNeurs[t]].o[h].target].active=!e.outs[e.neurons[e.activeNeurs[t]].o[h].target].active:(-1==n.indexOf(e.neurons[e.activeNeurs[t]].o[h].target)&&n.push(e.neurons[e.activeNeurs[t]].o[h].target),e.neurons[e.neurons[e.activeNeurs[t]].o[h].target].active=!0),e.currPath[0].push([e.activeNeurs[t],e.neurons[e.activeNeurs[t]].o[h]]),e.activePath[0].push([e.activeNeurs[t],e.neurons[e.activeNeurs[t]].o[h]])))}var u=document.querySelector("#sensL").getBoundingClientRect(),l=document.querySelector("#sensR").getBoundingClientRect(),d=document.querySelector("#prey").getBoundingClientRect(),g=(e.playw-Math.sqrt(Math.pow(u.left-d.left,2)+Math.pow(u.top-d.top,2)))/e.playw,m=(e.playw-Math.sqrt(Math.pow(l.left-d.left,2)+Math.pow(l.top-d.top,2)))/e.playw;e.ins[0].active=Math.random()<g/5,e.ins[1].active=Math.random()<m/5,e.ins[2].active=Math.random()<3*g/5,e.ins[3].active=Math.random()<3*m/5;for(var f=0;f<e.ins.length;f++){a=[];for(r=0;r<e.ins[f].o.length;r++)for(var o=Math.ceil(99*e.ins[f].o[r].weight),s=0;s<o;s++)a.push(r);i=a[Math.floor(Math.random()*a.length)],Math.random()>.02&&e.ins[f].active&&(-1==n.indexOf(e.ins[f].o[i].target)&&n.push(e.ins[f].o[i].target),e.neurons[e.ins[f].o[i].target].active=!0,e.currPath[1].push([f,e.ins[f].o[i]]),e.activePath[1].push([f,e.ins[f].o[i]]))}for(e.remainingEn-=n.length*e.enPerNeur,t=0;t<e.outs.length;t++)e.outs[t].active&&e.outs[t].does();if(e.movePrey(),e.activeNeurs/e.numNeurs>.95)console.log("Death from: overheat at",(new Date).getTime()),e.lastDeath="Overheat",e.die(g,m);else if(e.remainingEn<=0)console.log("Death from: lack of energy at",(new Date).getTime()),e.lastDeath="Lack of energy",e.die(g,m);else if(!n.length&&e.hasStarted)console.log("Death from: lack of neural activity at",(new Date).getTime()),e.lastDeath="Lack of neural activity",e.die(g,m);else if(e.okayRun)if(Math.sqrt(Math.pow(e.org.x-e.prey.x,2)+Math.pow(e.org.y-e.prey.y,2))<35)console.log("Successful hunt!"),e.lastDeath="Successful hunt",e.die(g,m,!0);else setTimeout(function(){e.activeNeurs=[],e.activeNeurs=n,e.$apply(),e.drawBoard(),e.run()},e.speed);else console.log("Death from: killed at",(new Date).getTime()),e.lastDeath="User",e.rpt=!1,e.die(g,m)},e.changePaths=function(n){for(var t=0;t<e.currPath[0].length;t++)e.neurons[e.currPath[0][t][0]]&&e.neurons[e.currPath[0][t][0]].o[e.currPath[0][t][1]]&&(e.neurons[e.currPath[0][t][0]].o[e.currPath[0][t][1]].weight+=n?.02:-.02,e.neurons[e.currPath[0][t][0]].o[e.currPath[0][t][1]].weight<.02?e.neurons[e.currPath[0][t][0]].o[e.currPath[0][t][1]].weight=.02:e.neurons[e.currPath[0][t][0]].o[e.currPath[0][t][1]].weight>.98&&(e.neurons[e.currPath[0][t][0]].o[e.currPath[0][t][1]].weight=.98));for(t=0;t<e.currPath[1].length;t++)e.ins[e.currPath[1][t][0]]&&e.ins[e.currPath[1][t][0]].o[e.currPath[1][t][1]]&&(e.ins[e.currPath[1][t][0]].o[e.currPath[1][t][1]].weight+=n?.02:-.02,e.ins[e.currPath[1][t][0]].o[e.currPath[1][t][1]].weight<.02?e.ins[e.currPath[1][t][0]].o[e.currPath[1][t][1]].weight=.02:e.ins[e.currPath[1][t][0]].o[e.currPath[1][t][1]].weight>.98&&(e.ins[e.currPath[1][t][0]].o[e.currPath[1][t][1]].weight=.98));e.currPath=[[],[]]},e.die=function(n,t,a){var r=e.remainingEn/12e4*200;r+=400*(n+t)/2,a&&(r+=e.org.y<e.prey.y?40:0,r+=60*(e.playw-Math.abs(e.prey.x-e.org.x))/e.playw),e.scores.push(r),e.scoreGraff.data.datasets[0].data.push(r),e.scoreGraff.data.labels.push(e.scores.length),e.scores.length>=3?(e.scoreAvg=e.scores.slice(-3).reduce(function(e,n){return e+n})/3,e.scoreAvgs.push(e.scoreAvg),e.scoreAvgs.length>50&&e.scoreAvgs.shift(),e.scoreGraff.data.datasets[1].data.push(e.scoreAvg),e.changePaths(r>e.scoreAvg)):e.scoreGraff.data.datasets[1].data.push(r),3==e.scores.length?e.scChart=new Chart(document.querySelector("#score-canv"),e.scoreGraff):e.scores.length>3&&e.scChart.update(),e.scoreGraff.data.labels.length>50&&(e.scoreGraff.data.datasets[0].data.shift(),e.scoreGraff.data.datasets[1].data.shift(),e.scoreGraff.data.labels.shift()),e.running=!1,e.hasStarted=!1,e.rpt&&e.resetBrain()},e.hasStarted=!1,e.running=!1,e.startSim=function(){e.neurons[0].active=!0,e.numGenerations++,e.totalEn=12e4,e.remainingEn=e.totalEn,e.hasStarted||(e.hasStarted=!0,e.run())},e.resetBrain=function(){e.hasStarted=!1,e.running=!1;for(var n=0;n<e.neurons.length;n++)e.neurons[n].active=!1;for(var t=0;t<e.ins.length;t++)e.ins[t].active=!1;for(var a=0;a<e.outs.length;a++)e.outs[a].active=!1;e.prey={x:.5*e.w,y:.5*e.h,dx:10*Math.random()-5,dy:10*Math.random()-5,facing:0},e.org={x:0,y:0},e.startSim()}}]);